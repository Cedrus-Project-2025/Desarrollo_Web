<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot</title>
    
    <!-- Importar Material Symbols Rounded -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet">
    
    <!-- Para CSS -->
    <link rel="stylesheet" href="../static/css/chatbot.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        #main-content {
            width: 100%;
            height: 100%;
        }
        /* Estilos para asegurar que el chatbot flote sobre el contenido */
        #chatbot-toggler, .chatbot-popup {
            position: fixed;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- Contenedor para el contenido principal -->
    <div id="main-content">
        <!-- Aquí se cargará el contenido de main.html -->
    </div>

    <!-- Chatbot -->
    <button id="chatbot-toggler">
        <span class="material-symbols-rounded">mode_comment</span>
        <span class="material-symbols-rounded">close</span>
    </button>

    <div class="chatbot-popup">
        <!-- Chatbot Header -->
        <div class="chat-header">
            <div class="header-info">
                <h2 class="logo-text">Asistente Virtual</h2>
            </div>
            <button id="close-chatbot">
                <span class="material-symbols-rounded">
                    keyboard_arrow_down
                </span>
            </button>
        </div>

        <!-- Chatbot Body -->
        <div class="chat-body">
            <div class="message bot-message thinking">
                <!--LOGO -->
                <svg class="bot-avatar" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"
                viewBox="0 0 512 512" xml:space="preserve">
               <g>
                   <circle style="fill:#55C1B4;" cx="256" cy="100.174" r="22.261"/>
                   <rect x="456.348" y="233.739" style="fill:#55C1B4;" width="44.522" height="133.565"/>
                   <rect x="11.13" y="233.739" style="fill:#55C1B4;" width="44.522" height="133.565"/>
               </g>
               <polygon style="fill:#C8EBE3;" points="167.699,166.957 100.174,166.957 55.652,166.957 55.652,434.087 456.348,434.087 456.348,166.957 "/>
               <g>
                   <circle style="fill:#55C1B4;" cx="166.957" cy="278.261" r="22.261"/>
                   <circle style="fill:#55C1B4;" cx="345.043" cy="278.261" r="22.261"/>
               </g>
               <path style="fill:#3B629D;" d="M256,378.435c30.736,0,55.652-24.917,55.652-55.652H200.348C200.348,353.518,225.264,378.435,256,378.435z"/>
               </svg>
           
                <div class="message-text">¡Hola! ¿En qué puedo ayudarte hoy? 😊</div>
            </div>
        </div>

        <!-- Chatbot Footer !-->
        <div class="chat-footer">
            <form action="#" class="chat-form">
                <textarea placeholder="Escribe un mensaje..." class="message-input" required></textarea>
                <div class="chat-controls">
                    <button type="submit" id="send-message">
                        <span class="material-symbols-rounded">arrow_upward</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!--script for emoji picker --> 
    <script src="https://cdn.jsdelivr.net/npm/@emoji-mart/react/dist/emoji-mart.js"></script>

    <!-- Para JavaScript -->
    <script src="../static/js/chatbot.js"></script>
    
    <!-- Script para cargar el contenido principal -->
    <script>
        // Función para cargar el contenido principal
function loadMainContent(url = '/projects/main') {
    console.log("Cargando contenido desde:", url);
    
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error('Respuesta de red no fue ok');
            }
            return response.text();
        })
        .then(html => {
            // Extraer solo el contenido del body
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const mainContent = doc.body.innerHTML;
            
            // Insertar el contenido en el div
            document.getElementById('main-content').innerHTML = mainContent;
            
            // Cargar scripts de main.html si hay
            const scripts = doc.querySelectorAll('script');
            scripts.forEach(script => {
                if (script.src) {
                    const newScript = document.createElement('script');
                    newScript.src = script.src;
                    document.body.appendChild(newScript);
                } else {
                    eval(script.textContent);
                }
            });
            
            // Cargar estilos de main.html si hay
            const styles = doc.querySelectorAll('link[rel="stylesheet"]');
            styles.forEach(style => {
                if (!document.querySelector(`link[href="${style.href}"]`)) {
                    const newStyle = document.createElement('link');
                    newStyle.rel = 'stylesheet';
                    newStyle.href = style.href;
                    document.head.appendChild(newStyle);
                }
            });
            
            // Interceptar clicks en enlaces para navegación SPA
            setupLinkInterception();
        })
        .catch(error => {
            console.error('Error al cargar contenido:', error);
            // Si falla la carga, intentar cargar el contenido principal por defecto
            if (url !== '/projects/main') {
                loadMainContent('/projects/main');
            }
        });
}

// Función para interceptar clicks en enlaces
function setupLinkInterception() {
    // Obtener todos los enlaces en el contenido principal
    const links = document.querySelectorAll('#main-content a');
    
    links.forEach(link => {
        link.addEventListener('click', function(e) {
            // Obtener la URL del enlace
            const href = this.getAttribute('href');
            
            // Solo interceptar enlaces internos (que no sean externos o anclas)
            if (href && !href.startsWith('http') && !href.startsWith('#') && !href.startsWith('mailto:') && !href.startsWith('tel:')) {
                e.preventDefault(); // Prevenir navegación normal
                
                // Actualizar la URL en la barra de direcciones sin recargar
                history.pushState({path: href}, '', href);
                
                // Cargar el contenido de la nueva página
                loadMainContent(href);
            }
        });
    });
}

// Manejar navegación con botones adelante/atrás del navegador
window.addEventListener('popstate', function(event) {
    console.log("Evento popstate detectado, estado:", event.state);
    
    // Obtener la ruta actual desde el estado o la URL actual
    const currentPath = event.state && event.state.path 
        ? event.state.path 
        : window.location.pathname;
    
    // Si estamos en la raíz o no hay ruta específica, cargar main
    if (currentPath === '/' || currentPath === '') {
        loadMainContent('/projects/main');
    } else {
        loadMainContent(currentPath);
    }
});

// Guardar el estado inicial cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
    // Guardar la ruta inicial en el historial
    const initialPath = window.location.pathname;
    history.replaceState({path: initialPath || '/projects/main'}, '', initialPath);
    
    // Cargar el contenido inicial
    if (initialPath === '/' || initialPath === '') {
        loadMainContent('/projects/main');
    } else {
        loadMainContent(initialPath);
    }
});
    </script>
</body>
</html>